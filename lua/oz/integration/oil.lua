local M = {}
local term = require("oz.term")
local util = require("oz.util")
local p = require("oz.persistcmd")

function M.oil_init(term_key, compile_key)
	vim.api.nvim_create_autocmd("FileType", {
		pattern = "oil",
		callback = function(event)
			vim.keymap.set("n", term_key or "<leader>av", function()
				local oil_cwd = require("oil").get_current_dir()
				local cmd = p.getoilcmd(oil_cwd) or ""
				local input = util.UserInput(":Term ", cmd)
				if input then
					if cmd ~= input then
						p.setoilcmd(oil_cwd, input)
					end
					term.run_in_term(input, oil_cwd)
				end
			end, { buffer = event.buf, silent = true, desc = "run cmd in cwd with oz_term" })

			vim.keymap.set("n", compile_key or "<leader>ac", function()
				local oil_cwd = require("oil").get_current_dir()
				vim.g.compilation_directory = oil_cwd
				local cmd = p.getoilcmd(oil_cwd) or ""
				local input = util.UserInput(":Compile ", cmd)
				if input then
					if cmd ~= input then
						p.setoilcmd(oil_cwd, input)
					end
					vim.cmd("Compile " .. input)
				end
			end, { buffer = event.buf, silent = true, desc = "run cmd in cwd with compile_mode" })

			-- show keymaps
			vim.keymap.set("n", "g?", function()
				util.Show_buf_keymaps({ subtext = { "~ generated by oz" } })
			end, { buffer = event.buf, silent = true, desc = "show all keymaps" })
		end,
	})
end
return M
